<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>C-MADONG Chatbot</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="app" role="application" aria-label="Chatbot interface">
    <aside class="sidebar" aria-label="controls">
      <div class="brand">
        <img src="Nong_C-MADONG.png" alt="C-Madong logo" class="logo" style="width:44px;height:44px;border-radius:10px;object-fit:cover" />
        <div>
          <h1>C-Madong Agentic Chatbot</h1>
          <div class="small">‡∏ô‡πâ‡∏≠‡∏á‡∏ã‡∏µ‡∏°‡∏∞‡πÇ‡∏î‡πà‡∏á‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ô‡∏¥‡∏™‡∏¥‡∏ï‡∏´‡∏≠‡∏û‡∏±‡∏Å‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô!</div>
        </div>
      </div>

      <div>
        <label for="session" class="small">Session ID</label>
        <div class="session-row">
          <input id="session" type="text" value="session-001" aria-label="session id" />
          <button id="clear">Clear</button>
        </div>
      </div>

      <div>
        <label class="small">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏ö‡πà‡∏≠‡∏¢</label>
        <div class="preset-list" role="list">
          <div class="preset" tabindex="0" data-msg="‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô">üë©üèª‚Äçüíª ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</div>
          <div class="preset" tabindex="0" data-msg="‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏´‡∏≠‡∏û‡∏±‡∏Å">‚è±Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏´‡∏≠‡∏û‡∏±‡∏Å</div>
          <div class="preset" tabindex="0" data-msg="‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°">üõ†Ô∏è ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</div>
        </div>
      </div>

      <div class="info small">API endpoint:<br><code style="font-size:12px;color:var(--muted)">https://n8n.srv1114184.hstgr.cloud/webhook/chatbot-api-ui</code></div>
    </aside>

    <section class="chat-area" aria-live="polite">
      <header class="header">
        <div style="display:flex;align-items:center;gap:10px">
          <div style="width:44px;height:44px;border-radius:10px;background:var(--glass);display:flex;align-items:center;justify-content:center">üí¨</div>
          <div>
            <div class="title">üü¢ C-MADONG ‚Äî Live</div>
            <div class="small">Connected to n8n webhook</div>
          </div>
        </div>
      </header>

      <div class="messages" id="messages" role="log" aria-live="polite" aria-relevant="additions text">
        <!-- messages appear here -->
      </div>

      <form class="composer" id="composer" aria-label="Send message to chatbot">
        <textarea id="input" rows="1" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á (‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏ö‡πà‡∏≠‡∏¢)" aria-label="‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°"></textarea>
        <button type="submit" class="send" id="send">‡∏™‡πà‡∏á</button>
      </form>
    </section>
  </div>

  <script>
    //line-liff add
    import liff from "@line/liff";
    liff.init({
    liffId: "2008522886-3zgmaRmJ", // Use own liffId
    });
    // Configuration
    const API_URL = 'https://n8n.srv1114184.hstgr.cloud/webhook/chatbot-api-ui';

    // DOM refs
    const messagesEl = document.getElementById('messages');
    const inputEl = document.getElementById('input');
    const composer = document.getElementById('composer');
    const sessionInput = document.getElementById('session');
    const clearBtn = document.getElementById('clear');
    const presets = document.querySelectorAll('.preset');

    // Utilities
    function appendMessage({who='bot', text='', meta=''}){
      const el = document.createElement('div');
      el.className = 'msg ' + (who==='user' ? 'user':'bot');
      if(meta) el.innerHTML = `<div class="meta">${meta}</div>` + `<div class="content">${escapeHtml(text).replace(/\n/g,'<br/>')}</div>`;
      else el.innerHTML = `<div class="content">${escapeHtml(text).replace(/\n/g,'<br/>')}</div>`;
      messagesEl.appendChild(el);
      // scroll to true bottom; previous calculation could overshoot and cause weird clipping
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function escapeHtml(text){
      const t = document.createTextNode(text || '');
      const div = document.createElement('div');
      div.appendChild(t);
      return div.innerHTML;
    }

    function showTyping(){
      const el = document.createElement('div');
      el.className = 'msg bot typing';
      el.id = 'typing';
      el.innerHTML = '<div class="dots"><span></span><span></span><span></span></div>';
      messagesEl.appendChild(el);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }
    function hideTyping(){
      const t = document.getElementById('typing');
      if(t) t.remove();
    }

    async function sendMessage(raw){
      const sessionId = (sessionInput.value || 'session-001').trim();
      // show user's message first
      appendMessage({who:'user', text: raw, meta: `You ¬∑ ${new Date().toLocaleTimeString()}`});
      inputEl.value = '';
      inputEl.focus();

      // show typing indicator
      showTyping();

      try{
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: raw, sessionId })
        });

        hideTyping();

        if(!res.ok){
          appendMessage({who:'bot', text:`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: HTTP ${res.status}`});
          return;
        }

        // try to parse JSON
        const json = await res.json();

        // Response shape in your example: { "output": "text..." }
        // We handle several common possibilities gracefully
        let botText = '';
        if(typeof json.output === 'string') botText = json.output;
        else if(typeof json.output === 'object' && json.output !== null){
          // flatten object to readable string
          botText = JSON.stringify(json.output, null, 2);
        } else if(typeof json.message === 'string') botText = json.message;
        else botText = JSON.stringify(json);

        appendMessage({who:'bot', text: botText, meta: `Bot ¬∑ ${new Date().toLocaleTimeString()}`});

      }catch(err){
        hideTyping();
        console.error(err);
        appendMessage({who:'bot', text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ ‚Äî ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠ URL ‡∏Ç‡∏≠‡∏á API'});
      }
    }

    // handle submit
    composer.addEventListener('submit', (e)=>{
      e.preventDefault();
      const text = inputEl.value.trim();
      if(!text) return;
      sendMessage(text);
    });

    // Enter to send, Shift+Enter newline
    inputEl.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' && !e.shiftKey){
        e.preventDefault();
        composer.requestSubmit();
      }
    });

    // preset clicks
    presets.forEach(p=>p.addEventListener('click', ()=>{
      const msg = p.dataset.msg || p.textContent.trim();
      inputEl.value = msg;
      inputEl.focus();
    }));

    presets.forEach(p=>p.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' || e.key === ' '){
        e.preventDefault();
        p.click();
      }
    }));

    // Clear session
    clearBtn.addEventListener('click', ()=>{ sessionInput.value = ''; sessionInput.focus(); });

    // seed conversation example
    appendMessage({who:'Bot', text:'‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ! ‡∏ô‡πâ‡∏≠‡∏á‡∏ã‡∏µ‡∏°‡∏∞‡πÇ‡∏î‡πà‡∏á‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞! ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ô‡πâ‡∏≠‡∏á‡∏ô‡∏¥‡∏™‡∏¥‡∏ï‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ ‡πÄ‡∏ä‡πà‡∏ô "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô"', meta:`üëßüèª ‡∏ô‡πâ‡∏≠‡∏á‡∏ã‡∏µ‡∏°‡∏∞‡πÇ‡∏î‡πà‡∏á ¬∑ ${new Date().toLocaleTimeString()}`});

    // Responsive autosize for textarea
    function autoSize(){
      inputEl.style.height = 'auto';
      inputEl.style.height = (inputEl.scrollHeight) + 'px';
    }
    inputEl.addEventListener('input', autoSize);
    autoSize();

    // small utility: allow programmatic call (for integration/testing)
    window.__chatbot = { sendMessage };

  </script>
</body>
</html>